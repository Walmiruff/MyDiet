<h4>Plano Alimentar</h4>
<div class="card">
    <div class="card-body">
        <h5 class="card-title h5-custom">Utiliza tabelas de alimentos, com informações sobre nutrientes.</h5>
        <h6 class="card-subtitle mb-2 text-muted">Recurso que te ajuda na elaboração das dietas conforme distribuição
            energética, macronutrientes e micronutrientes.</h6>
        <br>
        <div class="container">
            <div class="row">
                <div class="col-md-4 mr-3">
                    <div class="row">
                        <form [formGroup]="formPlanoAlim">
                            <div class="col-sm-12 mb-3">
                                <label class="strong-class" for="desc">Descrição</label>
                                <textarea class="form-control note-editor note-editor-margin" cols="30" rows="10"
                                    maxlength="200" id="descricao" formControlName="descricao"></textarea>
                                <small>
                                    Caracteres restantes
                                    <span>{{ formPlanoAlim.get('descricao').value === null ? 200 : 200 - formPlanoAlim.get('descricao').value.length }}</span>
                                </small>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="col-md-7">
                    <div class="d-flex justify-content-between">
                        <label for="desc" class="strong-class">Refeições</label>
                        <div>
                            <button type="submit" class="btn btn-success  mr-2"
                                (click)="clearModalRef(); classicModal.show()">Adicionar</button>
                        </div>
                    </div>
                    <hr>
                    <!--Refeiçoes-->
                    <div class="ref-custom" *ngIf="refeicoes$ | async as refs">
                        <div class="row mb-5" *ngFor="let ref of refs">
                            <div class="col-sm-4">
                                <div class="row">
                                    <div class="col-12 d-flex justify-content-end">
                                        <p>{{ ref.horario }} - {{ ref.descricao }}</p>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-sm-12 d-flex justify-content-end">
                                        <em class="fa mr-2 fas fa-edit"
                                            (click)="updateRef(ref.id, false); classicModal.show()"></em>
                                        <em class="fa mr-2 fas fa-trash" (click)="deleteRef(ref.id)"></em>
                                        <em class="fa mr-2 fas fa-copy"
                                            (click)="updateRef(ref.id, true); classicModal.show()"></em>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-8">
                                <ul *ngFor="let alim of ref.alimentos | primOrSecOp: 1">
                                    <li class="d-flex justify-content-between" (click)="showAlimInfo(alim); alimDetailModal.show()">
                                        <a>{{ alim.descricao }}</a>
                                        <p>{{ alim.quantidade }} - {{ alim.porcao }}</p>
                                    </li>
                                </ul>
                                <p *ngIf="hasSecondOption(ref.alimentos)"><strong>Segunda Opção</strong></p>
                                <ul *ngFor="let alim of ref.alimentos | primOrSecOp: 2">
                                    <li class="d-flex justify-content-between" (click)="showAlimInfo(alim); alimDetailModal.show()">
                                        <a>{{ alim.descricao }}</a>
                                        <p>{{ alim.quantidade }} - {{ alim.porcao }}</p>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mb-2">
            <div class="col-lg-10">
                <!-- <p class="card-text">*Escolha qual protocolo utilizar, dependendo do sexo e ciclo da vida do paciente. A
                    escolha
                    do protocolo depende da sua conduta profissional.
                    <br>
                    **Gasto energético será usado para cálculo no plano alimentar.
                </p> -->
            </div>
            <div class="col-lg-2" style="text-align: right;">
                <button type="button" class="btn btn-outline-primary">Download pdf</button>
            </div>
        </div>
    </div>
</div>



<!--Modal Ref-->
<div class="modal fade" bsModal #classicModal="bs-modal" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel"
    aria-hidden="true" [hidden]="hiddenModalRef" [config]="{ignoreBackdropClick: true, keyboard: false}">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Refeição</h4>
                <button type="button" class="close" aria-label="Close" (click)="classicModal.hide()">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" style="overflow-y: auto; height: 450px;">
                <div class="container">
                    <form [formGroup]="formModalRef">

                        <div class="row" style="max-width: 496px;">
                            <div class="col-sm-5 form-group">
                                <label class="col-form-label strong-class">Horário*</label>
                                <input class="form-control" id="horarioRefeicao" formControlName="horarioRefeicao"
                                    type="time" placeholder="hh:mm" />
                            </div>
                            <div class="col-sm-7 form-group">
                                <label class="col-form-label strong-class">Descrição*</label>
                                <select id="tipoRefeicao" class="form-control" formControlName="tipoRefeicao"
                                    id="tipoRefeicao">
                                    <option value="Café da Manhã">Café da Manhã</option>
                                    <option value="Lanche da Manhã">Lanche da Manhã</option>
                                    <option value="Almoço">Almoço</option>
                                    <option value="Lanche da Tarde">Lanche da Tarde</option>
                                    <option value="Jantar">Jantar</option>
                                    <option value="Lanche da Noite">Lanche da Noite</option>
                                    <option value="Lanche Extra 1">Lanche Extra 1</option>
                                    <option value="Lanche Extra 2">Lanche Extra 2</option>
                                </select>
                            </div>
                        </div>

                        <div class="row mt-2">
                            <div class="col-12">
                                <label class="col-form-label strong-class">Observação</label>
                                <textarea id="observacaoRefeicao" formControlName="observacaoRefeicao"
                                    class="form-control" maxlength="500"></textarea>
                                <small>Caracteres restantes <span>{{ formModalRef.get('observacaoRefeicao').value === null ? 200 : 200 - formModalRef.get('observacaoRefeicao').value.length }}</span></small>
                            </div>
                        </div>

                        <div class="row mt-5">
                            <div class="col-12">
                                <div class="d-flex justify-content-between">
                                    <h5>Alimentos Selecionados</h5>
                                    <button type="button" class="mr-1 mb-1 btn btn-outline-primary"
                                        (click)="smModal.show(); modalHiddenRef(); clearModalAlim(); addOptionFalse()">+
                                        Adicionar Alimento</button>
                                </div>
                            </div>
                        </div>
                    </form>
                    <br>
                    <div class="row">
                        <div class="col-12">
                            <div *ngIf="alimStorePrimary$ | async as alimsPrimary">
                                <div *ngFor="let alim of alimsPrimary">
                                    <hr>
                                    <div class="row d-flex justify-content-between">
                                        <div class="col-9">
                                            <p class="p-custom">{{ alim.descricao }} ( {{ alim.porcao }} :
                                                {{alim.quantidade}} )</p>
                                        </div>
                                        <div class="col-3">
                                            <div class="row">
                                                <div class="row"
                                                    (click)="updateAlim(alim.id); smModal.show(); modalHiddenRef(); addOptionFalse()">
                                                    <em class="fa mr-2 fas fa-edit">
                                                    </em>
                                                    <p class="p-custom-color">Editar</p>
                                                </div>
                                                <div class="row ml-5" (click)="removeAlim(alim.idAlimento)">
                                                    <em class="fa mr-2 fas fa-trash">
                                                    </em>
                                                    <p class="p-custom-color">Remover</p>

                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-2">
                        <div class="col-12">
                            <div *ngIf="alimStoreSecond$ | async as alimsSecondary">
                                <br>
                                <p *ngIf="alimsSecondary.length > 0"><strong>Segunda Opção</strong></p>
                                <div *ngFor="let alim of alimsSecondary">
                                    <hr>
                                    <div class="row d-flex justify-content-between">
                                        <div class="col-9">
                                            <p class="p-custom">{{ alim.descricao }} ( {{ alim.porcao }} :
                                                {{alim.quantidade}} )</p>
                                        </div>
                                        <div class="col-3">
                                            <div class="row">
                                                <div class="row"
                                                    (click)="updateAlim(alim.id); smModal.show(); modalHiddenRef(); addOptionFalse()">
                                                    <em class="fa mr-2 fas fa-edit">
                                                    </em>
                                                    <p class="p-custom-color">Editar</p>
                                                </div>
                                                <div class="row ml-5" (click)="removeAlim(alim.idAlimento)">
                                                    <em class="fa mr-2 fas fa-trash">
                                                    </em>
                                                    <p class="p-custom-color">Remover</p>

                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex space-between modal-footer">
                <div>
                    <button type="button" class="btn btn-success"
                        (click)="smModal.show(); modalHiddenRef(); clearModalAlim(); addOption()">+Add 2ª Opção</button>
                </div>
                <div>
                    <button type="button" class="btn btn-info mr-2" data-dismiss="modal"
                        (click)="classicModal.hide()">Cancelar</button>
                    <button type="button" class="btn btn-primary"
                        (click)="classicModal.hide();smModal.hide(); saveOrUpdateRef()" [disabled]="formModalRef.invalid">Salvar</button>
                </div>
            </div>
        </div>
    </div>
</div>


<!--Modal Alim-->
<div bsModal #smModal="bs-modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel"
    aria-hidden="true" [config]="{ignoreBackdropClick: true, keyboard: false}">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Adicionar Alimento</h4>
                <button type="button" class="close" aria-label="Close" (click)="smModal.hide(); modalHiddenRef()">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!--Start Tabela Alimentos-->
                <form [formGroup]="formModalAlim">
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="row">
                                <div class="col-sm-2">
                                    <strong>
                                        Tabela de Alimentos
                                    </strong>
                                </div>
                                <div class="col-sm-10">
                                    <div class="row">
                                        <div class="form-check-label" *ngFor="let item of tabelas">
                                            <label class="form-check-label mx-3">
                                                <input type="radio" class="form-check-input" [value]="item.valor"
                                                    formControlName="tabelas" />
                                                {{ item.nome }}
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>


                    <div *ngIf="alimentos$ | async as alimentos">
                        <div class="row mt-3">
                            <div class="col-6">
                                <label>
                                    <strong>
                                        Alimento
                                    </strong>
                                </label>
                                <select class="form-control" formControlName="alimento" id="alimento">
                                    <option *ngFor="let alim of alimentos" [value]="alim.id">{{ alim.descricao }}
                                    </option>
                                </select>
                            </div>
                            <div class="col-6 d-flex align-items-end">
                                <!-- <button id="btn-novo-alim" class="btn btn-link" (click)="novaPorcao()"
                                    disabled>Cadastrar Novo
                                    Alimento</button> -->
                            </div>
                        </div>

                        <div class="row mt-3">
                            <div class="col-6">
                                <label>
                                    <strong>
                                        Porção
                                    </strong>
                                </label>
                                <select class="form-control" formControlName="porcoes" id="porcoes">
                                    <option *ngFor="let porcao of porcoes"
                                        [value]="porcao.gramas + '-' + porcao.descricao">
                                        {{ porcao.descricao }}
                                    </option>
                                </select>
                            </div>
                            <div class="col-6 d-flex align-items-end">
                                <button id="btn-nova-porcao" class="btn btn-link" (click)="porcaoModal.show()">Cadastrar
                                    Nova
                                    Porção</button>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-3 mb-4">
                        <div class="col-4">
                            <label>
                                <strong>
                                    Quantidade <i class="fas fa-info-circle" title="Quantidade referente a porção que você selecionou. Por exemplo se selecionou Colher, coloque quantas colheres deseja"></i>
                                </strong>
                            </label>
                            <input type="text" class="form-control" formControlName="quantidade" id="quantidade" type="number" step="0.1">
                        </div>
                    </div>

                </form>
                <!--End Tabela Alimentos-->

            </div>
            <div class="modal-footer">
                <button [disabled]="formModalAlim.controls.porcoes.value === null" id="btn-mostrar-nutrientes-alimento" type="button" class="btn btn-info" (click)="buildAndShowAlimInfo();alimDetailModal.show()">Mostrar
                    Nutrientes</button>
                <button [disabled]="formModalAlim.controls.porcoes.value === null" id="btn-add-alimento-continuar" type="button" class="btn btn-primary"
                    (click)="saveAlim(); resetModalAlim()">Incluir e
                    Continuar</button>
                <button [disabled]="formModalAlim.controls.porcoes.value === null" id="btn-add-alimento-fechar" type="button" class="btn btn-success"
                    (click)="saveAlim(); smModal.hide(); modalHiddenRef()">Incluir e Fechar</button>
                <button type="button" class="btn btn-default" (click)="smModal.hide(); modalHiddenRef()">Fechar</button>
            </div>
        </div>
    </div>
</div>

<!--Moda cadastro porcoes-->
<div bsModal #porcaoModal="bs-modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel"
    aria-hidden="true" [config]="{ignoreBackdropClick: true, keyboard: false}">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Nova Porção</h4>
                <button type="button" class="close" aria-label="Close" (click)="porcaoModal.hide()">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form [formGroup]="formPorcao">
                    <div class="row">
                        <div class="col-12">
                            <label>Descrição</label>
                            <input type="text" class="form-control" formControlName="descricao"
                                placeholder="Colher, xícara, copo..." id="desc">
                        </div>
                    </div>
                    <br>
                    <div class="row">
                        <div class="col-12">
                            <label>Quantidade (gramas)</label>
                            <input type="text" class="form-control" formControlName="gramas" placeholder="g" id="gramas" type="number" step="0.1" >
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary mr-2" (click)="porcaoModal.hide()">Cancelar</button>
                <button type="button" [disabled]="formPorcao.invalid" class="btn btn-primary" (click)="porcaoModal.hide(); onConfirm()"
                    data-dismiss="modal">Salvar</button>
            </div>
        </div>
    </div>
</div>


<!--Moda Alim Detalhes-->
<div bsModal #alimDetailModal="bs-modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel"
  aria-hidden="true" [config]="{ignoreBackdropClick: true, keyboard: false}">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title">Cardápios Pré-Cadastrados</h4>
        <button type="button" class="close" aria-label="Close" (click)="alimDetailModal.hide()">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
          <div *ngIf="alimentoCalculado$ | async as alim">
            {{ alim.calorias }}
          </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-primary mr-2" (click)="alimDetailModal.hide()">ok</button>
      </div>
    </div>
  </div>
</div>